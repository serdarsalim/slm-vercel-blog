<!DOCTYPE html>
<html>
<head>
  <title>Google Apps Script API Test</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
    h1 { color: #4285f4; /* Google blue */ }
    h2 { color: #34a853; /* Google green */ }
    pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
    input, textarea { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #4285f4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #3367d6; }
    .success { color: #34a853; font-weight: bold; }
    .error { color: #ea4335; /* Google red */ font-weight: bold; }
    .tabs { display: flex; margin-bottom: 10px; }
    .tab { padding: 8px 16px; cursor: pointer; background: #f1f1f1; margin-right: 5px; border-radius: 4px 4px 0 0; }
    .tab.active { background: #4285f4; color: white; }
    .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-radius: 0 4px 4px 4px; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <h1>Google Apps Script API Test Tool</h1>
  <p>This page helps simulate how Google Apps Script sends requests to your API.</p>
  
  <div class="tabs">
    <div class="tab active" data-tab="fetch">UrlFetchApp Simulation</div>
    <div class="tab" data-tab="cors">CORS Test</div>
    <div class="tab" data-tab="debug">Debug Info</div>
  </div>
  
  <div id="fetch-tab" class="tab-content active">
    <h2>Test Your API with UrlFetchApp Simulation</h2>
    
    <div>
      <label for="apiEndpoint">API Endpoint:</label>
      <input id="apiEndpoint" type="text" value="/api/author/authenticate" placeholder="Path to your API (e.g., /api/author/authenticate)">
    </div>
    
    <div>
      <label for="handle">Author Handle:</label>
      <input id="handle" type="text" value="TBH" placeholder="Enter author handle">
    </div>
    
    <div>
      <label for="authorToken">API Token:</label>
      <input id="authorToken" type="text" value="55a9855c032ca6bd7ee540cff62afb535e14598e664c31371c63d9d32ec2e2ac" placeholder="Enter API token">
    </div>
    
    <div>
      <button onclick="testUrlFetchApp()">Test UrlFetchApp Simulation</button>
    </div>
    
    <h3>Response:</h3>
    <div id="gasFetchStatus"></div>
    <pre id="gasFetchResult">Click the button to test...</pre>
  </div>
  
  <div id="cors-tab" class="tab-content">
    <h2>CORS Test</h2>
    <p>This tests the basic CORS functionality of your API endpoint.</p>
    
    <div>
      <button onclick="testCORS()">Test CORS Headers</button>
    </div>
    
    <h3>Response:</h3>
    <div id="corsStatus"></div>
    <pre id="corsResult">Click the button to test...</pre>
  </div>
  
  <div id="debug-tab" class="tab-content">
    <h2>Debug Information</h2>
    <p>Information about your current environment to help with troubleshooting.</p>
    
    <div>
      <button onclick="generateDebugInfo()">Generate Debug Info</button>
    </div>
    
    <h3>Browser & Environment:</h3>
    <pre id="debugInfo">Click the button to generate info...</pre>
  </div>
  
  <script>
    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Test UrlFetchApp simulation
    async function testUrlFetchApp() {
      const endpoint = document.getElementById('apiEndpoint').value;
      const handle = document.getElementById('handle').value;
      const authorToken = document.getElementById('authorToken').value;
      const statusDiv = document.getElementById('gasFetchStatus');
      const resultPre = document.getElementById('gasFetchResult');
      
      statusDiv.innerHTML = '<span style="color: #fbbc05;">Testing...</span>';
      resultPre.textContent = '';
      
      try {
        // This simulates how Google Apps Script sends data
        const payload = {
          handle: handle,
          authorToken: authorToken
        };
        
        // Log what we're about to send
        console.log('Sending to:', window.location.origin + endpoint);
        console.log('Payload:', payload);
        
        // These options simulate UrlFetchApp's behavior
        const options = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'GoogleAppsScript'
          },
          body: JSON.stringify(payload)
        };
        
        // Execute the request
        const response = await fetch(endpoint, options);
        const responseText = await response.text();
        
        // Display response headers
        const headers = {};
        response.headers.forEach((value, key) => {
          headers[key] = value;
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', headers);
        console.log('Response text:', responseText);
        
        // Process response
        if (response.ok) {
          try {
            const data = JSON.parse(responseText);
            statusDiv.innerHTML = '<span class="success">Success! ✓</span>';
            resultPre.textContent = `Status: ${response.status}\n\nHeaders: ${JSON.stringify(headers, null, 2)}\n\nData: ${JSON.stringify(data, null, 2)}`;
          } catch (e) {
            statusDiv.innerHTML = '<span class="error">Error parsing JSON ✗</span>';
            resultPre.textContent = `Status: ${response.status}\n\nHeaders: ${JSON.stringify(headers, null, 2)}\n\nRaw: ${responseText}`;
          }
        } else {
          statusDiv.innerHTML = `<span class="error">HTTP Error: ${response.status} ✗</span>`;
          resultPre.textContent = `Status: ${response.status}\n\nHeaders: ${JSON.stringify(headers, null, 2)}\n\nResponse: ${responseText}`;
        }
      } catch (error) {
        statusDiv.innerHTML = '<span class="error">Fetch Error ✗</span>';
        resultPre.textContent = error.toString();
      }
    }
    
    // Test CORS
    async function testCORS() {
      const endpoint = document.getElementById('apiEndpoint').value;
      const statusDiv = document.getElementById('corsStatus');
      const resultPre = document.getElementById('corsResult');
      
      statusDiv.innerHTML = '<span style="color: #fbbc05;">Testing CORS...</span>';
      resultPre.textContent = '';
      
      try {
        // Send OPTIONS request to test CORS
        const response = await fetch(endpoint, {
          method: 'OPTIONS',
          headers: {
            'Origin': 'https://script.google.com',
            'Access-Control-Request-Method': 'POST',
            'Access-Control-Request-Headers': 'Content-Type, X-Requested-With'
          }
        });
        
        // Extract CORS headers
        const corsHeaders = {
          'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
          'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
          'access-control-allow-headers': response.headers.get('access-control-allow-headers'),
          'access-control-max-age': response.headers.get('access-control-max-age')
        };
        
        // Check if CORS is properly configured
        const hasValidCORS = corsHeaders['access-control-allow-origin'] && 
                           corsHeaders['access-control-allow-methods'] && 
                           corsHeaders['access-control-allow-headers'];
        
        if (response.status === 204 && hasValidCORS) {
          statusDiv.innerHTML = '<span class="success">CORS configured correctly! ✓</span>';
        } else if (response.status === 200 && hasValidCORS) {
          statusDiv.innerHTML = '<span class="success">CORS working but returns 200 instead of 204 ✓</span>';
        } else {
          statusDiv.innerHTML = '<span class="error">CORS not properly configured ✗</span>';
        }
        
        resultPre.textContent = `Status: ${response.status}\n\nCORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`;
      } catch (error) {
        statusDiv.innerHTML = '<span class="error">CORS Test Error ✗</span>';
        resultPre.textContent = error.toString();
      }
    }
    
    // Generate debug info
    function generateDebugInfo() {
      const debugPre = document.getElementById('debugInfo');
      
      // Collect browser and environment info
      const info = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        cookiesEnabled: navigator.cookieEnabled,
        currentURL: window.location.href,
        host: window.location.host,
        origin: window.location.origin,
        protocol: window.location.protocol,
        screenSize: {
          width: window.screen.width,
          height: window.screen.height
        },
        windowSize: {
          innerWidth: window.innerWidth,
          innerHeight: window.innerHeight
        },
        highResDisplay: window.devicePixelRatio > 1,
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        dateTimeNow: new Date().toString()
      };
      
      debugPre.textContent = JSON.stringify(info, null, 2);
    }
  </script>
</body>
</html>